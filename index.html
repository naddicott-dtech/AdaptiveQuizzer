<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
  <title>Adaptive Quiz</title>
  <style>
    /* Basic styling for the canvas/game */
    html, body, #canvas {
      margin: 0;
      padding: 0;
      border: 0;
    }
    body {
      color: white;
      background-color: black;
      overflow: hidden; /* hides scrollbars; can obscure large absolutely positioned elements */
      touch-action: none;
    }
    #canvas {
      display: block;
    }
    #canvas:focus {
      outline: none;
    }
    /* Godot loading overlay */
    #status, #status-splash, #status-progress {
      position: absolute;
      left: 0;
      right: 0;
    }
    #status, #status-splash {
      top: 0;
      bottom: 0;
    }
    #status {
      background-color: #242424;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      visibility: hidden;
    }
    #status-splash {
      max-height: 100%;
      max-width: 100%;
      margin: auto;
    }
    #status-progress, #status-notice {
      display: none;
    }
    #status-progress {
      bottom: 10%;
      width: 50%;
      margin: 0 auto;
    }
    #status-notice {
      background-color: #5b3943;
      border-radius: 0.5rem;
      border: 1px solid #9b3943;
      color: #e0e0e0;
      font-family: 'Noto Sans', 'Droid Sans', Arial, sans-serif;
      line-height: 1.3;
      margin: 0 2rem;
      overflow: hidden;
      padding: 1rem;
      text-align: center;
      z-index: 1;
    }

    /* OPTIONAL: Hide the canvas until login is successful, if you like
       #canvas {
         display: none;
       }
    */
  </style>
  <link id="-gd-engine-icon" rel="icon" type="image/png" href="index.icon.png" />
  <link rel="apple-touch-icon" href="index.apple-touch-icon.png" />

  <!-- Google Identity Services library (auto-init approach) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- Godot canvas -->
  <canvas id="canvas">Your browser does not support the canvas tag.</canvas>
  <noscript>Your browser does not support JavaScript.</noscript>

  <!-- Godot loading status overlay -->
  <div id="status">
    <img id="status-splash" src="index.png" alt="" />
    <progress id="status-progress"></progress>
    <div id="status-notice"></div>
  </div>

  <!-- ============= GOOGLE SIGN-IN AUTO-RENDER ============= -->
  <div id="g_id_onload"
       data-client_id="294482887266-a801ub2fml6usudbh1qvddf1f576r0jc.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>

  <script>
    // Called by Google Identity Services after user chooses an account
    async function handleCredentialResponse(response) {
      const idToken = response.credential;
      if (!idToken) {
        console.error("No credential found in the response");
        alert("Login failed: No token received. The game will not load.");
        return;
      }

      console.log("Credential received:", idToken);
      try {
        // Verify token on your backend
        const res = await fetch('https://adaptive-quiz-back-end-nealaddicott.replit.app/verify-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_token: idToken })
        });
        const data = await res.json();
        console.log("Backend response:", data);

        if (data.success) {
          console.log("Login successful for:", data.email);
          // OPTIONAL: store the user email locally
          localStorage.setItem("user_email", data.email);

          // If you want to log the login on the backend:
          await logLogin(data.email);

          // (1) Register the service worker only after login is confirmed
          await registerServiceWorker();

          // (2) Now start the Godot game
          startGodotGame();
        } else {
          alert("Authentication failed: " + (data.error || "No details provided"));
          console.error("Login failed, game not started.");
        }
      } catch (err) {
        console.error("Error verifying token:", err);
        alert("Error verifying token. The game will not load.");
      }
    }

    // Log login event (optional)
    async function logLogin(email) {
      try {
        const res = await fetch('https://adaptive-quiz-back-end-nealaddicott.replit.app/log_login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        console.log("Login logged:", data);
      } catch (err) {
        console.error("Error logging login:", err);
      }
    }

    // Register the service worker once user is authenticated
    async function registerServiceWorker() {
      if (!("serviceWorker" in navigator)) {
        console.warn("Service workers not supported in this browser.");
        return;
      }
      try {
        const registration = await navigator.serviceWorker.register("coi-serviceworker.js");
        console.log("Service worker registered with scope:", registration.scope);
      } catch (error) {
        console.error("Service worker registration failed:", error);
      }
    }

    // ===== Godot engine initialization (unchanged) =====
    function startGodotGame() {
      // Engine config
      const GODOT_CONFIG = {
        "args": [],
        "canvasResizePolicy": 2,
        "ensureCrossOriginIsolationHeaders": false,
        "executable": "index",
        "experimentalVK": false,
        "fileSizes": { "index.pck": 8112, "index.wasm": 43016933 },
        "focusCanvas": true,
        "gdextensionLibs": []
      };
      const GODOT_THREADS_ENABLED = false;
      const engine = new Engine(GODOT_CONFIG);

      (function () {
        const statusOverlay = document.getElementById("status");
        const statusProgress = document.getElementById("status-progress");
        const statusNotice = document.getElementById("status-notice");
        let initializing = true;
        let statusMode = "";

        function setStatusMode(mode) {
          if (statusMode === mode || !initializing) return;
          if (mode === "hidden") {
            statusOverlay.remove();
            initializing = false;
            return;
          }
          statusOverlay.style.visibility = "visible";
          statusProgress.style.display = mode === "progress" ? "block" : "none";
          statusNotice.style.display = mode === "notice" ? "block" : "none";
          statusMode = mode;
        }

        function setStatusNotice(text) {
          while (statusNotice.lastChild) {
            statusNotice.removeChild(statusNotice.lastChild);
          }
          const lines = text.split("\n");
          lines.forEach((line) => {
            statusNotice.appendChild(document.createTextNode(line));
            statusNotice.appendChild(document.createElement("br"));
          });
        }

        function displayFailureNotice(err) {
          console.error(err);
          if (err instanceof Error) {
            setStatusNotice(err.message);
          } else if (typeof err === "string") {
            setStatusNotice(err);
          } else {
            setStatusNotice("An unknown error occurred");
          }
          setStatusMode("notice");
          initializing = false;
        }

        const missing = Engine.getMissingFeatures({ threads: GODOT_THREADS_ENABLED });
        if (missing.length !== 0) {
          const missingMsg = "Error\nThe following features required to run Godot projects on the Web are missing:\n";
          displayFailureNotice(missingMsg + missing.join("\n"));
        } else {
          setStatusMode("progress");
          engine.startGame({
            onProgress: function (current, total) {
              if (current > 0 && total > 0) {
                statusProgress.value = current;
                statusProgress.max = total;
              } else {
                statusProgress.removeAttribute("value");
                statusProgress.removeAttribute("max");
              }
            }
          }).then(() => {
            setStatusMode("hidden");
          }, displayFailureNotice);
        }
      })();
    }
  </script>

  <!-- The Godot engine code must match 'executable' name in GODOT_CONFIG -->
  <script src="index.js"></script>
</body>
</html>
